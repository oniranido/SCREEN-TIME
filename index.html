<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Digital Well Being</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --primary: #4f8cff;
      --bg: #f7f9fb;
      --text: #222;
      --card: #fff;
      --accent: #e0e7ef;
      --shadow: 0 2px 16px rgba(79,140,255,0.08);
      --transition: 0.3s cubic-bezier(.4,0,.2,1);
    }
    [data-theme="dark"] {
      --primary: #4f8cff;
      --bg: #181c23;
      --text: #f7f9fb;
      --card: #232834;
      --accent: #2a31440;
      --shadow: 0 2px 16px rgba(79,140,255,0.15);
    }
    html, body {
      margin: 0; padding: 0;
      font-family: 'Segoe UI', Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      transition: background var(--transition), color var(--transition);
    }
    .auth-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.45);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 2200;
    }
    .auth-card {
      background: var(--card);
      color: var(--text);
      padding: 1.25rem;
      border-radius: 12px;
      width: 340px;
      box-shadow: var(--shadow);
      display: flex;
      flex-direction: column;
      gap: 0.6rem;
    }
    .auth-card input {
      padding: 0.6rem;
      border-radius: 8px;
      border: 1px solid rgba(0,0,0,0.08);
      background: transparent;
      font-size: 0.95rem;
    }
    .auth-card button {
      margin-top: 0.4rem;
      padding: 0.6rem;
      border-radius: 8px;
      border: none;
      background: var(--primary);
      color: #fff;
      cursor: pointer;
      font-weight: 600;
    }
    .auth-card .link-btn {
      background: transparent;
      color: var(--primary);
      border: none;
      margin-top: 0;
      padding: 0;
      font-size: 0.98em;
      cursor: pointer;
      text-decoration: underline;
    }
    #logoutBtn {
      position: fixed;
      top: 1.1rem;
      right: 4.6rem;
      background: var(--accent);
      border: none;
      border-radius: 8px;
      padding: 0.45rem 0.7rem;
      cursor: pointer;
      display: none;
      z-index: 2100;
    }
    .container {
      max-width: 480px;
      margin: 2rem auto 0 auto;
      background: var(--card);
      border-radius: 1.2rem;
      box-shadow: var(--shadow);
      padding: 2rem 1.5rem 1.5rem 1.5rem;
      display: flex;
      flex-direction: column;
      gap: 2rem;
      animation: fadeIn 1s;
      position: relative;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(30px);}
      to { opacity: 1; transform: translateY(0);}
    }
    h1 {
      text-align: center;
      font-size: 2rem;
      margin-bottom: 0.5rem;
      letter-spacing: 1px;
    }
    .timer-section {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 1.2rem;
    }
    .timer-display {
      font-size: 2.5rem;
      font-weight: 600;
      letter-spacing: 2px;
      background: var(--accent);
      padding: 0.7em 1.5em;
      border-radius: 0.8em;
      margin-bottom: 0.5em;
      transition: background var(--transition);
      user-select: none;
    }
    .timer-controls {
      display: flex;
      gap: 0.7em;
    }
    .timer-controls button {
      background: var(--primary);
      color: #fff;
      border: none;
      border-radius: 0.5em;
      padding: 0.5em 1.2em;
      font-size: 1rem;
      font-weight: 500;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(79,140,255,0.10);
      transition: background var(--transition), transform 0.1s;
    }
    .timer-controls button:active { transform: scale(0.96); }
    .timer-controls button[disabled] { background: #b0c7f7; cursor: not-allowed; }
    .alarm-section {
      background: linear-gradient(120deg, #e0e7ef 60%, #cbe3ff 100%);
      border-radius: 1.2em;
      padding: 1.5em 1em 1em 1em;
      margin-bottom: 1em;
      box-shadow: 0 2px 12px rgba(79,140,255,0.10);
      display: flex;
      flex-direction: column;
      gap: 1.1em;
      position: relative;
      overflow: hidden;
      transition: background var(--transition);
    }
    [data-theme="dark"] .alarm-section {
      background: linear-gradient(120deg, #2a31440 60%, #3a4a6b 100%);
    }
    .alarm-section::before {
      content: "";
      position: absolute;
      top: -40px; right: -40px;
      width: 120px; height: 120px;
      background: rgba(79,140,255,0.10);
      border-radius: 50%;
      z-index: 0;
    }
    .alarm-section form, .alarm-section ul { position: relative; z-index: 1; }
    .alarm-section label {
      font-size: 1.05em;
      font-weight: 500;
      color: #3a4a6b;
      margin-bottom: 0.2em;
      display: flex;
      align-items: center;
      gap: 0.5em;
    }
    [data-theme="dark"] .alarm-section label { color: #b0c7f7; }
    .alarm-section input[type="number"], .alarm-section input[type="text"], .alarm-section select {
      padding: 0.35em 0.7em;
      border-radius: 0.5em;
      border: 1px solid #b0c7f7;
      font-size: 1em;
      background: #fff;
      margin-right: 0.5em;
      transition: border 0.2s;
    }
    [data-theme="dark"] .alarm-section input[type="number"], [data-theme="dark"] .alarm-section input[type="text"], [data-theme="dark"] .alarm-section select {
      background: #232834;
      color: #e0e7ef;
      border: 1px solid #4f8cff;
    }
    .alarm-section input[type="number"]:focus, .alarm-section input[type="text"]:focus, .alarm-section select:focus {
      border: 1.5px solid #4f8cff;
      outline: none;
    }
    .alarm-section input[type="file"] { margin-top: 0.3em; font-size: 0.95em; }
    .alarm-section button[type="submit"] {
      background: linear-gradient(90deg, #4f8cff 60%, #6fc3ff 100%);
      color: #fff;
      border: none;
      border-radius: 0.7em;
      padding: 0.6em 1.5em;
      font-size: 1.08em;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(79,140,255,0.10);
      margin-top: 0.7em;
      transition: background 0.2s, transform 0.1s;
    }
    .alarm-section button[type="submit"]:hover { background: linear-gradient(90deg, #6fc3ff 60%, #4f8cff 100%); transform: translateY(-2px) scale(1.03); }
    .alarm-section ul {
      margin-top: 0.7em; padding: 0; list-style: none;
    }
    .alarm-section ul li {
      background: rgba(255,255,255,0.85);
      border-radius: 0.7em;
      margin-bottom: 0.5em;
      padding: 0.6em 1em;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: 0 1px 4px rgba(79,140,255,0.06);
      font-size: 1em;
      transition: background 0.2s;
    }
    [data-theme="dark"] .alarm-section ul li { background: #232834; }
    .alarm-section ul li span b { color: #4f8cff; font-weight: 600; letter-spacing: 0.5px; }
    .alarm-section ul li button {
      background: #e0e7ef; color: #4f8cff; border: none; border-radius: 0.5em; padding: 0.3em 0.9em; font-size: 0.98em; font-weight: 500; margin-left: 0.2em; cursor: pointer;
    }
    .alarm-section ul li button:hover { background: #4f8cff; color: #fff; }
    [data-theme="dark"] .alarm-section ul li button { background: #2a31440; color: #b0c7f7; }
    [data-theme="dark"] .alarm-section ul li button:hover { background: #4f8cff; color: #fff; }
    .alarm-section .alarm-title {
      font-size: 1.18em; font-weight: 700; color: #4f8cff; margin-bottom: 0.7em; letter-spacing: 0.5px; text-align: left; display: flex; align-items: center; gap: 0.5em;
    }
    [data-theme="dark"] .alarm-section .alarm-title { color: #b0c7f7; }
    .analytics-section {
      background: var(--accent);
      border-radius: 0.8em;
      padding: 1em;
      box-shadow: 0 1px 4px rgba(79,140,255,0.04);
      transition: background var(--transition);
    }
    .analytics-section h2 { font-size: 1.2rem; margin: 0 0 0.5em 0; text-align: center; letter-spacing: 0.5px; }
    .session-list { max-height: 180px; overflow-y: auto; margin: 0; padding: 0; list-style: none; }
    .session-list li { display: flex; justify-content: space-between; align-items: center; padding: 0.5em 0.2em; border-bottom: 1px solid #e6eaf0; font-size: 0.98em; animation: fadeIn 0.5s; }
    .dashboard-section { margin-top: 1.5em; background: var(--card); border-radius: 0.8em; padding: 1em 0.5em; box-shadow: 0 1px 4px rgba(79,140,255,0.04); transition: background var(--transition); }
    .dashboard-section h2 { font-size: 1.1rem; margin: 0 0 0.5em 0; text-align: center; }
    .dark-toggle {
      position: absolute; top: 1.2em; right: 1.2em; background: var(--accent); border: none; border-radius: 50%; width: 2.2em; height: 2.2em; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 1px 4px rgba(79,140,255,0.08); transition: background var(--transition);
    }
    .dark-toggle svg { width: 1.3em; height: 1.3em; fill: var(--primary); transition: fill var(--transition); }
    .caution-popup {
      position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.35); display: flex; align-items: center; justify-content: center; z-index: 1000; animation: fadeIn 0.3s;
    }
    .caution-content {
      background: var(--card); color: var(--text); border-radius: 1em; box-shadow: var(--shadow); padding: 2em 1.5em 1.5em 1.5em; text-align: center; max-width: 90vw; min-width: 260px; animation: fadeIn 0.4s;
    }
    .caution-content h2 { color: #e67e22; margin-bottom: 0.7em; }
    .caution-content button { margin: 0.5em 0.7em 0 0.7em; background: var(--primary); color: #fff; border: none; border-radius: 0.5em; padding: 0.5em 1.2em; font-size: 1rem; font-weight: 500; cursor: pointer; box-shadow: 0 2px 8px rgba(79,140,255,0.10); transition: background var(--transition), transform 0.1s; }
    .caution-content button:active { transform: scale(0.96); }
    footer { margin: 2em 0 1em 0; text-align: center; color: #888; font-size: 0.98em; letter-spacing: 0.2px; user-select: none; }
    @media (max-width: 600px) {
      .container { max-width: 98vw; padding: 1.2rem 0.5rem 1rem 0.5rem; }
      .dashboard-section, .analytics-section, .alarm-section { padding: 0.7em 0.2em; }
    }
    .session-list li { opacity: 0; animation: fadeIn 0.5s forwards; }
    .session-list li:nth-child(n) { animation-delay: 0.05s; }
    .session-list li:nth-child(2) { animation-delay: 0.1s; }
    .session-list li:nth-child(3) { animation-delay: 0.15s; }
    .session-list li:nth-child(4) { animation-delay: 0.2s; }
    .session-list li:nth-child(5) { animation-delay: 0.25s; }
    .session-list li:nth-child(6) { animation-delay: 0.3s; }
    .session-list li:nth-child(7) { animation-delay: 0.35s; }
    .session-list li:nth-child(8) { animation-delay: 0.4s; }
    .session-list li:nth-child(9) { animation-delay: 0.45s; }
    .session-list li:nth-child(10) { animation-delay: 0.5s; }
  </style>
</head>
<body>
  <!-- Auth overlay (sign in / signup) -->
  <div id="authOverlay" class="auth-overlay" aria-hidden="true">
    <div class="auth-card" id="signInCard" role="dialog" aria-modal="true" aria-labelledby="authTitle">
      <h3 id="authTitle" style="margin:0;">Sign in to Digital Well Being</h3>
      <input id="authEmail" type="email" placeholder="Email" autocomplete="username" />
      <input id="authPassword" type="password" placeholder="Password" autocomplete="current-password" />
      <button id="authSignIn" type="button">Sign in</button>
      <button class="link-btn" id="showSignup" type="button">Create account</button>
      <p style="margin:0;font-size:.85rem;color:#666;">This demo stores accounts in localStorage. Not secure for production.</p>
    </div>
    <div class="auth-card" id="signUpCard" style="display:none;" role="dialog" aria-modal="true" aria-labelledby="signupTitle">
      <h3 id="signupTitle" style="margin:0;">Create Account</h3>
      <input id="signupEmail" type="email" placeholder="Email" autocomplete="username" />
      <input id="signupPassword" type="password" placeholder="Password" autocomplete="new-password" />
      <button id="signupBtn" type="button">Create account</button>
      <button class="link-btn" id="showSignIn" type="button">Back to sign in</button>
      <p style="margin:0;font-size:.85rem;color:#666;">This demo stores accounts in localStorage. Not secure for production.</p>
    </div>
  </div>

  <!-- Logout button -->
  <button id="logoutBtn" type="button">Log out</button>

  <!-- Dark Mode Toggle Button -->
  <button class="dark-toggle" id="darkToggle" title="Toggle dark mode" aria-label="Toggle dark mode">
    <svg id="darkIcon" viewBox="0 0 24 24">
      <path d="M12 3a1 1 0 0 1 1 1v1a1 1 0 1 1-2 0V4a1 1 0 0 1 1-1zm6.364 2.636a1 1 0 0 1 1.414 1.414l-.707.707a1 1 0 1 1-1.414-1.414l.707-.707zM21 11a1 1 0 1 1 0 2h-1a1 1 0 1 1 0-2h1zm-2.636 6.364a1 1 0 0 1-1.414 1.414l-.707-.707a1 1 0 1 1 1.414-1.414l.707.707zM12 19a1 1 0 0 1-1-1v-1a1 1 0 1 1 2 0v1a1 1 0 0 1-1 1zm-6.364-2.636a1 1 0 0 1-1.414-1.414l.707-.707a1 1 0 1 1 1.414 1.414l-.707.707zM3 13a1 1 0 1 1 0-2h1a1 1 0 1 1 0 2H3zm2.636-6.364a1 1 0 0 1 1.414-1.414l.707.707A1 1 0 1 1 6.05 7.05l-.707-.707z"/>
    </svg>
  </button>

  <div class="container" id="mainContainer">
    <h1>Digital Well Being</h1>
    <!-- Timer Section -->
    <div class="timer-section">
      <div class="timer-display" id="timerDisplay">00:00:00</div>
      <div class="timer-controls">
        <button id="startBtn" type="button">Start</button>
        <button id="pauseBtn" type="button" disabled>Pause</button>
        <button id="resumeBtn" type="button" disabled>Resume</button>
        <button id="resetBtn" type="button" disabled>Reset</button>
      </div>
    </div>
    <!-- Multiple Alarms Section -->
    <div class="alarm-section">
      <div class="alarm-title">
        <svg width="22" height="22" fill="none" viewBox="0 0 24 24"><path fill="#4f8cff" d="M12 22a2 2 0 0 1-2-2h4a2 2 0 0 1-2 2Zm6-6V11a6 6 0 1 0-12 0v5l-2 2v1h16v-1l-2-2Zm-8 0V11a4 4 0 1 1 8 0v5H6Z"/></svg>
        Alarm Settings
      </div>
      <form id="alarmForm" autocomplete="off" style="margin-bottom:1em;">
        <label>
          After
          <input type="number" id="alarmHours" min="0" max="23" value="0" style="width:3em;"> h
          <input type="number" id="alarmMinutes" min="1" max="59" value="30" required> min
        </label>
        <label>
          Label
          <input type="text" id="alarmLabel" maxlength="32" value="Take a break" required>
        </label>
        <label>
          Tone
          <select id="alarmTone">
            <option value="iphone-sonnerie-270108.mp3">Buzzing</option>
            <option value="notification-bell-sound-376888.mp3">Soft Bell</option>
            <option value="new-notification-3-398649.mp3">Notify</option>
            <option value="czechoslovakia-eas-alarm-1968-extended-362029.mp3">Classic</option>
            <option value="custom">Upload MP3...</option>
          </select>
          <button id="previewToneBtn" type="button" style="margin-left:.5em;">Preview</button>
          <input type="file" id="customAlarmFile" accept="audio/*" style="display:none;">
        </label>
        <button type="submit" style="margin-top:0.5em;">Add Alarm</button>
      </form>
      <ul id="alarmsList" style="margin:0;padding:0;list-style:none;"></ul>
    </div>
    <!-- Session History Section -->
    <div class="analytics-section">
      <h2>Session History</h2>
      <ul class="session-list" id="sessionList"></ul>
    </div>
    <!-- Analytics Dashboard Section -->
    <div class="dashboard-section">
      <h2>Analytics Dashboard</h2>
      <canvas id="chart" height="120"></canvas>
    </div>
  </div>

  <footer>
    &copy; 2025 Digital Well Being , Designed for the Management
  </footer>

  <audio id="alarmAudio" preload="auto" src="iphone-sonnerie-270108.mp3"></audio>

  <script>
    // --- Default tone constant ---
    const DEFAULT_TONE = 'iphone-sonnerie-270108.mp3';

    // --- Timer State ---
    let timer = {
      startTime: null,
      elapsed: 0,
      running: false,
      intervalId: null,
      sessionStart: null,
      sessionEnd: null
    };

    // --- Multiple Alarms State ---
    let alarms = [];
    let editingAlarmId = null;
    let alarmInterval = null;
    let previewObjectUrl = null;

    // --- DOM Elements ---
    const timerDisplay = document.getElementById('timerDisplay');
    const startBtn = document.getElementById('startBtn');
    const pauseBtn = document.getElementById('pauseBtn');
    const resumeBtn = document.getElementById('resumeBtn');
    const resetBtn = document.getElementById('resetBtn');
    const sessionList = document.getElementById('sessionList');
    const darkToggle = document.getElementById('darkToggle');
    const darkIcon = document.getElementById('darkIcon');
    const chartCanvas = document.getElementById('chart');
    const alarmForm = document.getElementById('alarmForm');
    const alarmHours = document.getElementById('alarmHours');
    const alarmMinutes = document.getElementById('alarmMinutes');
    const alarmLabel = document.getElementById('alarmLabel');
    const alarmTone = document.getElementById('alarmTone');
    const customAlarmFile = document.getElementById('customAlarmFile');
    const previewToneBtn = document.getElementById('previewToneBtn');
    const alarmsList = document.getElementById('alarmsList');
    const alarmAudio = document.getElementById('alarmAudio');

    const authOverlay = document.getElementById('authOverlay');
    const signInCard = document.getElementById('signInCard');
    const signUpCard = document.getElementById('signUpCard');
    const authSignIn = document.getElementById('authSignIn');
    const authEmail = document.getElementById('authEmail');
    const authPassword = document.getElementById('authPassword');
    const showSignup = document.getElementById('showSignup');
    const showSignIn = document.getElementById('showSignIn');
    const signupEmail = document.getElementById('signupEmail');
    const signupPassword = document.getElementById('signupPassword');
    const signupBtn = document.getElementById('signupBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const mainContainer = document.getElementById('mainContainer');

    // --- LocalStorage Keys ---
    const SESSIONS_KEY = 'digitalWellBeingSessions';
    const ALARMS_KEY = 'digitalWellBeingAlarms';
    const DARK_KEY = 'digitalWellBeingDark';
    const USERS_KEY = 'digitalWellBeingUsers';
    const SIGNED_KEY = 'dwb_signed_in';
    const SIGNED_EMAIL = 'dwb_user_email';

    // helper: return a per-user storage key (uses signed-in email)
    function userKey(baseKey) {
      const email = localStorage.getItem(SIGNED_EMAIL) || '';
      return `${baseKey}::${email || 'anon'}`;
    }

    // --- Utility: Format seconds as HH:MM:SS ---
    function formatTime(sec) {
      const h = Math.floor(sec / 3600).toString().padStart(2, '0');
      const m = Math.floor((sec % 3600) / 60).toString().padStart(2, '0');
      const s = (sec % 60).toString().padStart(2, '0');
      return `${h}:${m}:${s}`;
    }

    // --- Timer Functions ---
    function updateTimerDisplay() { timerDisplay.textContent = formatTime(timer.elapsed); }
    function tick() {
      if (timer.running) {
        const now = Date.now();
        timer.elapsed = Math.floor((now - timer.startTime) / 1000);
        updateTimerDisplay();
        checkAlarms();
      }
    }
    function startTimer() {
      timer.startTime = Date.now();
      timer.sessionStart = new Date();
      timer.elapsed = 0;
      timer.running = true;
      timer.intervalId = setInterval(tick, 1000);
      updateTimerDisplay();
      startBtn.disabled = true;
      pauseBtn.disabled = false;
      resumeBtn.disabled = true;
      resetBtn.disabled = false;
      alarms.forEach(a => a.triggered = false);
    }
    function pauseTimer() {
      if (!timer.running) return;
      clearInterval(timer.intervalId);
      timer.running = false;
      timer.elapsed = Math.floor((Date.now() - timer.startTime) / 1000);
      updateTimerDisplay();
      startBtn.disabled = true;
      pauseBtn.disabled = true;
      resumeBtn.disabled = false;
      resetBtn.disabled = false;
    }
    function resumeTimer() {
      timer.startTime = Date.now() - timer.elapsed * 1000;
      timer.running = true;
      timer.intervalId = setInterval(tick, 1000);
      updateTimerDisplay();
      startBtn.disabled = true;
      pauseBtn.disabled = false;
      resumeBtn.disabled = true;
      resetBtn.disabled = false;
    }
    function resetTimer() {
      if (timer.running) clearInterval(timer.intervalId);
      if (timer.elapsed > 0) {
        timer.sessionEnd = new Date();
        saveSession(timer.elapsed, timer.sessionStart, timer.sessionEnd);
      }
      timer.startTime = null;
      timer.elapsed = 0;
      timer.running = false;
      timer.sessionStart = null;
      timer.sessionEnd = null;
      updateTimerDisplay();
      startBtn.disabled = false;
      pauseBtn.disabled = true;
      resumeBtn.disabled = true;
      resetBtn.disabled = true;
      alarms.forEach(a => a.triggered = false);
      hideCaution();
    }

    // --- Multiple Alarms Logic ---
    function checkAlarms() {
      for (const alarm of alarms) {
        const alarmSeconds = (parseInt(alarm.hours) * 3600) + (parseInt(alarm.minutes) * 60);
        if (!alarm.triggered && timer.elapsed === alarmSeconds) {
          alarm.triggered = true;
          showCaution(alarm);
          playAlarm(alarm);
          break;
        }
      }
    }

    // simplified: always set audio src to selected tone (or customSrc), don't whitelist filenames
    function playAlarm(alarm) {
      stopPreviewObjectUrl();
      if (alarm && alarm.tone === 'custom' && alarm.customSrc) {
        alarmAudio.src = alarm.customSrc;
      } else {
        // use saved tone value if present, otherwise fallback to DEFAULT_TONE
        alarmAudio.src = alarm && alarm.tone ? alarm.tone : DEFAULT_TONE;
      }
      // ensure load and play
      try { alarmAudio.load(); } catch(e){}
      alarmAudio.currentTime = 0;
      alarmAudio.volume = 1.0;
      alarmAudio.play().catch(()=>{ /* autoplay may be blocked until user interacts */ });
      if (alarmInterval) clearInterval(alarmInterval);
      alarmInterval = setInterval(() => {
        try { alarmAudio.currentTime = 0; alarmAudio.play().catch(()=>{}); } catch(e){}
      }, 3000);
      showNotification(alarm.label || "Alarm", "Your alarm time is up!");
    }

    function stopAlarm() {
      alarmAudio.pause();
      alarmAudio.currentTime = 0;
      if (alarmInterval) {
        clearInterval(alarmInterval);
        alarmInterval = null;
      }
    }
    function snoozeAlarm(alarm) {
      stopAlarm();
      hideCaution();
      alarm.triggered = false;
      const totalSec = timer.elapsed + 5 * 60;
      alarm.hours = Math.floor(totalSec / 3600);
      alarm.minutes = Math.floor((totalSec % 3600) / 60);
      saveAlarms();
      renderAlarms();
    }

    // --- Caution Popup ---
    function showCaution(alarm) {
      if (document.getElementById('cautionPopup')) return;
      const popup = document.createElement('div');
      popup.className = 'caution-popup';
      popup.id = 'cautionPopup';
      let timeStr = '';
      if (alarm.hours && alarm.hours > 0) timeStr += `${alarm.hours}h `;
      timeStr += `${alarm.minutes}min`;
      popup.innerHTML = `
        <div class="caution-content">
          <h2>⏰ ${alarm.label || "Time's Up!"}</h2>
          <p>You have reached your alarm: <b>${alarm.label}</b> (${timeStr})</p>
          <div style="display:flex;justify-content:center;gap:.6rem;">
            <button id="dismissAlarmBtn">Dismiss</button>
            <button id="snoozeAlarmBtn" style="background:#f0f4f9;color:var(--primary);border:1px solid rgba(79,140,255,0.14);">Snooze 5 min</button>
          </div>
        </div>
      `;
      document.body.appendChild(popup);
      document.getElementById('dismissAlarmBtn').onclick = () => { stopAlarm(); hideCaution(); };
      document.getElementById('snoozeAlarmBtn').onclick = () => { snoozeAlarm(alarm); };
    }
    function hideCaution() {
      const popup = document.getElementById('cautionPopup');
      if (popup) popup.remove();
    }

    // --- Notification API ---
    function showNotification(title, body) {
      if (!("Notification" in window)) return;
      if (Notification.permission === "granted") {
        new Notification(title, { body });
      } else if (Notification.permission !== "denied") {
        Notification.requestPermission().then(permission => {
          if (permission === "granted") new Notification(title, { body });
        });
      }
    }

    // --- Session Storage (per-user) ---
    function getSessions() {
      const data = localStorage.getItem(userKey(SESSIONS_KEY));
      if (!data) return [];
      try { return JSON.parse(data); } catch { return []; }
    }
    function setSessions(sessions) { localStorage.setItem(userKey(SESSIONS_KEY), JSON.stringify(sessions)); }
    function saveSession(duration, startDate, endDate) {
      if (duration < 1) return;
      const sessions = getSessions();
      sessions.unshift({
        start: startDate ? startDate.toISOString() : null,
        end: endDate ? endDate.toISOString() : null,
        duration
      });
      setSessions(sessions);
      renderSessions();
      renderChart();
    }

    // --- Render Session List ---
    function renderSessions() {
      const sessions = getSessions();
      sessionList.innerHTML = '';
      if (sessions.length === 0) {
        sessionList.innerHTML = '<li style="text-align:center;color:#aaa;">No sessions yet.</li>';
        return;
      }
      sessions.slice(0, 10).forEach(session => {
        const start = session.start ? new Date(session.start) : null;
        const end = session.end ? new Date(session.end) : null;
        let dateStr = '';
        if (start && end) {
          dateStr = `${start.toLocaleDateString()} ${start.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})} - ${end.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}`;
        } else if (start) {
          dateStr = `${start.toLocaleDateString()} ${start.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}`;
        }
        const li = document.createElement('li');
        li.innerHTML = `
          <span class="session-date">${dateStr}</span>
          <span class="session-duration">${formatTime(session.duration)}</span>
        `;
        sessionList.appendChild(li);
      });
    }

    // --- Chart.js Analytics Dashboard ---
    let chartInstance = null;
    function renderChart() {
      const sessions = getSessions();
      const dailyTotals = {};
      sessions.forEach(s => {
        const day = s.start ? s.start.slice(0,10) : (s.date ? s.date.slice(0,10) : "");
        if (!day) return;
        dailyTotals[day] = (dailyTotals[day] || 0) + s.duration;
      });
      const labels = Object.keys(dailyTotals).reverse().slice(-7);
      const data = labels.map(day => Math.round(dailyTotals[day] / 60));
      if (chartInstance) chartInstance.destroy();
      chartInstance = new Chart(chartCanvas, {
        type: 'bar',
        data: {
          labels: labels.map(d => d.slice(5)),
          datasets: [{
            label: 'Total Screen Time (min)',
            data,
            backgroundColor: 'rgba(79,140,255,0.7)',
            borderRadius: 6,
            maxBarThickness: 32
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: false },
            tooltip: { callbacks: { label: ctx => `${ctx.parsed.y} min` } }
          },
          scales: {
            y: { beginAtZero: true, ticks: { color: getComputedStyle(document.body).getPropertyValue('--text') } },
            x: { ticks: { color: getComputedStyle(document.body).getPropertyValue('--text') } }
          }
        }
      });
    }

    // --- Dark Mode (per-user) ---
    function setDarkMode(on) {
      document.documentElement.setAttribute('data-theme', on ? 'dark' : 'light');
      localStorage.setItem(userKey(DARK_KEY), on ? '1' : '0');
      darkIcon.innerHTML = on
        ? `<path d="M21.64 13.64A9 9 0 1 1 10.36 2.36a7 7 0 1 0 11.28 11.28z"/>`
        : `<path d="M12 3a1 1 0 0 1 1 1v1a1 1 0 1 1-2 0V4a1 1 0 0 1 1-1zm6.364 2.636a1 1 0 0 1 1.414 1.414l-.707.707a1 1 0 1 1-1.414-1.414l.707-.707zM21 11a1 1 0 1 1 0 2h-1a1 1 0 1 1 0-2h1zm-2.636 6.364a1 1 0 0 1-1.414 1.414l-.707-.707a1 1 0 1 1 1.414-1.414l.707.707zM12 19a1 1 0 0 1-1-1v-1a1 1 0 1 1 2 0v1a1 1 0 0 1-1 1zm-6.364-2.636a1 1 0 0 1-1.414-1.414l.707-.707a1 1 0 1 1 1.414 1.414l-.707.707zM3 13a1 1 0 1 1 0-2h1a1 1 0 1 1 0 2H3zm2.636-6.364a1 1 0 0 1 1.414-1.414l.707.707A1 1 0 1 1 6.05 7.05l-.707-.707z"/>`;
      renderChart();
    }
    function getDarkMode() { return localStorage.getItem(userKey(DARK_KEY)) === '1'; }
    darkToggle.onclick = () => setDarkMode(!getDarkMode());

    // --- Alarms Storage (per-user) ---
    function saveAlarms() {
      localStorage.setItem(userKey(ALARMS_KEY), JSON.stringify(alarms.map(a => ({
        id: a.id,
        hours: a.hours,
        minutes: a.minutes,
        label: a.label,
        tone: a.tone,
        customSrc: a.tone === 'custom' ? (a.customSrc || null) : null,
        triggered: false
      }))));
    }
    function loadAlarms() {
      const data = localStorage.getItem(userKey(ALARMS_KEY));
      if (!data) return [];
      try {
        const arr = JSON.parse(data);
        return arr.map(a => ({
          id: a.id || (Date.now().toString() + Math.random().toString(36).slice(2)),
          hours: (typeof a.hours !== 'undefined') ? a.hours : 0,
          minutes: (typeof a.minutes !== 'undefined') ? a.minutes : 0,
          label: a.label || 'Alarm',
          tone: a.tone || DEFAULT_TONE,
          customSrc: a.customSrc || null,
          triggered: false
        }));
      } catch (e) { return []; }
    }

    // --- Helpers for file reading and preview ---
    function readFileAsDataURL(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = () => reject(new Error('read error'));
        reader.readAsDataURL(file);
      });
    }
    function stopPreviewObjectUrl() {
      if (previewObjectUrl) {
        try { URL.revokeObjectURL(previewObjectUrl); } catch(e){}
        previewObjectUrl = null;
      }
    }
    function previewToneValue(value) {
      stopPreviewObjectUrl();
      if (!value) return;
      if (value === 'custom') {
        const f = customAlarmFile.files && customAlarmFile.files[0];
        if (f) {
          previewObjectUrl = URL.createObjectURL(f);
          alarmAudio.src = previewObjectUrl;
          alarmAudio.currentTime = 0;
          alarmAudio.play().catch(()=>{});
          setTimeout(() => stopPreviewObjectUrl(), 4000);
        } else if (editingAlarmId) {
          const alarm = alarms.find(a => a.id === editingAlarmId);
          if (alarm && alarm.customSrc) {
            alarmAudio.src = alarm.customSrc;
            alarmAudio.currentTime = 0;
            alarmAudio.play().catch(()=>{});
          } else {
            alert('No uploaded file to preview. Choose a file.');
          }
        } else {
          alert('Choose a file to preview.');
        }
      } else {
        alarmAudio.src = value || DEFAULT_TONE;
        alarmAudio.currentTime = 0;
        alarmAudio.play().catch(()=>{});
      }
    }

    // --- Render Alarms List (includes Play button) ---
    function renderAlarms() {
      alarmsList.innerHTML = '';
      if (alarms.length === 0) {
        alarmsList.innerHTML = '<li style="color:#888;text-align:center;">No alarms set.</li>';
        return;
      }
      alarms.forEach(alarm => {
        const li = document.createElement('li');
        li.style.display = 'flex';
        li.style.alignItems = 'center';
        li.style.justifyContent = 'space-between';
        li.style.padding = '0.3em 0';
        let timeStr = '';
        if (alarm.hours && alarm.hours > 0) timeStr += `${alarm.hours}h `;
        timeStr += `${alarm.minutes}min`;
        li.innerHTML = `
          <span>
            <b>${escapeHtml(alarm.label)}</b> &mdash; ${timeStr}
            ${alarm.tone === "custom" ? "🎵" : ""}
            ${["iphone-sonnerie-270108.mp3","notification-bell-sound-376888.mp3","new-notification-3-398649.mp3","czechoslovakia-eas-alarm-1968-extended-362029.mp3"].includes(alarm.tone) ? "🎶" : ""}
          </span>
          <span>
            <button data-play="${alarm.id}" style="margin-right:.3em;">Play</button>
            <button data-edit="${alarm.id}" style="margin-right:0.3em;">Edit</button>
            <button data-delete="${alarm.id}">Delete</button>
          </span>
        `;
        alarmsList.appendChild(li);
      });
      alarmsList.querySelectorAll('button[data-play]').forEach(btn => {
        btn.onclick = () => {
          const id = btn.getAttribute('data-play');
          const alarm = alarms.find(a => a.id === id);
          if (!alarm) return;
          stopPreviewObjectUrl();
          if (alarm.tone === 'custom' && alarm.customSrc) {
            alarmAudio.src = alarm.customSrc;
          } else {
            alarmAudio.src = alarm.tone || DEFAULT_TONE;
          }
          alarmAudio.currentTime = 0;
          alarmAudio.play().catch(()=>{});
          setTimeout(() => { alarmAudio.pause(); alarmAudio.currentTime = 0; }, 5000);
        };
      });
      alarmsList.querySelectorAll('button[data-edit]').forEach(btn => {
        btn.onclick = () => editAlarm(btn.getAttribute('data-edit'));
      });
      alarmsList.querySelectorAll('button[data-delete]').forEach(btn => {
        btn.onclick = () => deleteAlarm(btn.getAttribute('data-delete'));
      });
    }

    // --- HTML escape helper ---
    function escapeHtml(s) {
      return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
    }

    // --- Add/Edit/Delete Alarm (stores uploaded file as dataURL for persistence) ---
    alarmForm.onsubmit = async function(e) {
      e.preventDefault();
      const hours = parseInt(alarmHours.value) || 0;
      const minutes = parseInt(alarmMinutes.value) || 0;
      const label = (alarmLabel.value || 'Alarm').trim();
      const tone = alarmTone.value;
      const file = customAlarmFile.files && customAlarmFile.files[0];

      let customDataUrl = null;
      if (tone === 'custom' && file) {
        const allowed = ['audio/mp3','audio/mpeg','audio/ogg','audio/wav','audio/mp4','audio/x-m4a','audio/webm','audio/x-wav'];
        if (!allowed.includes(file.type) && !file.name.toLowerCase().endsWith('.mp3')) {
          alert('Unsupported audio file type. Please upload a common audio file (mp3, wav, ogg).');
          return;
        }
        customDataUrl = await readFileAsDataURL(file).catch(() => null);
        if (!customDataUrl) {
          alert('Failed to read uploaded audio.');
          return;
        }
      }

      if (editingAlarmId) {
        const idx = alarms.findIndex(a => a.id === editingAlarmId);
        if (idx !== -1) {
          alarms[idx].hours = hours;
          alarms[idx].minutes = minutes;
          alarms[idx].label = label;
          alarms[idx].tone = tone;
          if (tone === 'custom') {
            alarms[idx].customSrc = customDataUrl || alarms[idx].customSrc || null;
          } else {
            alarms[idx].customSrc = null;
          }
        }
        editingAlarmId = null;
        alarmForm.querySelector('button[type="submit"]').textContent = "Add Alarm";
      } else {
        const id = Date.now().toString() + Math.random().toString(36).slice(2);
        alarms.push({
          id,
          hours,
          minutes,
          label,
          tone,
          customSrc: tone === 'custom' ? (customDataUrl || null) : null,
          triggered: false
        });
      }

      alarmForm.reset();
      alarmHours.value = 0;
      customAlarmFile.style.display = 'none';
      stopPreviewObjectUrl();
      renderAlarms();
      saveAlarms();
    };

    function editAlarm(id) {
      const alarm = alarms.find(a => a.id === id);
      if (!alarm) return;
      alarmHours.value = alarm.hours || 0;
      alarmMinutes.value = alarm.minutes;
      alarmLabel.value = alarm.label;
      alarmTone.value = alarm.tone;
      customAlarmFile.style.display = alarm.tone === "custom" ? "" : "none";
      editingAlarmId = id;
      alarmForm.querySelector('button[type="submit"]').textContent = "Save Alarm";
    }
    function deleteAlarm(id) {
      if (!confirm('Delete this alarm?')) return;
      const idx = alarms.findIndex(a => a.id === id);
      if (idx !== -1) {
        alarms.splice(idx, 1);
        renderAlarms();
        saveAlarms();
      }
    }
    alarmTone.onchange = function() { customAlarmFile.style.display = alarmTone.value === "custom" ? "" : "none"; };
    previewToneBtn.addEventListener('click', () => previewToneValue(alarmTone.value));

    // --- Timer Button Event Listeners ---
    startBtn.onclick = startTimer;
    pauseBtn.onclick = pauseTimer;
    resumeBtn.onclick = resumeTimer;
    resetBtn.onclick = resetTimer;

    // --- Authentication (with signup) ---
    function getUsers() {
      try { return JSON.parse(localStorage.getItem(USERS_KEY) || '[]'); } catch { return []; }
    }
    function setUsers(users) {
      localStorage.setItem(USERS_KEY, JSON.stringify(users));
    }
    function isSignedIn() { return localStorage.getItem(SIGNED_KEY) === '1'; }
    function setSignedIn(email) { localStorage.setItem(SIGNED_KEY, '1'); localStorage.setItem(SIGNED_EMAIL, email || ''); }
    function clearSignedIn() { localStorage.removeItem(SIGNED_KEY); localStorage.removeItem(SIGNED_EMAIL); }

    function showAuthOverlay(showSignup = false) {
      authOverlay.style.display = 'flex';
      authOverlay.setAttribute('aria-hidden', 'false');
      mainContainer.style.filter = 'blur(2px) grayscale(.04)';
      logoutBtn.style.display = 'none';
      signInCard.style.display = showSignup ? 'none' : '';
      signUpCard.style.display = showSignup ? '' : 'none';
    }
    function hideAuthOverlay() {
      authOverlay.style.display = 'none';
      authOverlay.setAttribute('aria-hidden', 'true');
      mainContainer.style.filter = '';
      logoutBtn.style.display = 'inline-block';
    }

    showSignup.onclick = () => showAuthOverlay(true);
    showSignIn.onclick = () => showAuthOverlay(false);

    authSignIn.addEventListener('click', () => {
      const email = (authEmail.value || '').trim().toLowerCase();
      const pass = (authPassword.value || '').trim();
      if (!email || !pass) { alert('Enter email and password.'); return; }
      const users = getUsers();
      const user = users.find(u => u.email === email && u.pass === pass);
      if (!user) { alert('Invalid credentials.'); return; }
      setSignedIn(email);
      hideAuthOverlay();
      initAfterSignIn();
    });

    signupBtn.addEventListener('click', () => {
      const email = (signupEmail.value || '').trim().toLowerCase();
      const pass = (signupPassword.value || '').trim();
      if (!email || !pass) { alert('Enter email and password.'); return; }
      let users = getUsers();
      if (users.some(u => u.email === email)) { alert('Account already exists.'); return; }
      users.push({ email, pass });
      setUsers(users);
      setSignedIn(email);
      hideAuthOverlay();
      initAfterSignIn();
    });

    logoutBtn.addEventListener('click', () => {
      if (!confirm('Sign out?')) return;
      stopAlarm();
      clearSignedIn();
      showAuthOverlay(false);
      if (timer.running) pauseTimer();
    });

    // --- On Load: Render sessions, chart, dark mode, alarms (only after sign-in) ---
    function initAfterSignIn() {
      // apply per-user dark mode, alarms and sessions
      setDarkMode(getDarkMode());
      alarms = loadAlarms();
      renderAlarms();
      renderSessions();
      renderChart();
      updateTimerDisplay();
      if ("Notification" in window && Notification.permission !== "granted" && Notification.permission !== "denied") {
        Notification.requestPermission();
      }
      logoutBtn.style.display = 'inline-block';
    }

    window.addEventListener('load', () => {
      if (!isSignedIn()) {
        showAuthOverlay(false);
      } else {
        hideAuthOverlay();
        initAfterSignIn();
      }
    });

    // --- Accessibility: Keyboard shortcuts ---
    document.addEventListener('keydown', e => {
      if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
      if (e.code === 'Space') {
        if (timer.running) pauseTimer();
        else if (timer.elapsed > 0) resumeTimer();
        else startTimer();
      }
      if (e.code === 'KeyR') resetTimer();
      if (e.code === 'KeyD') setDarkMode(!getDarkMode());
    });
  </script>
</body>
</html>
